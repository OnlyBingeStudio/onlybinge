(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(n){if(n.ep)return;n.ep=!0;const a=o(n);fetch(n.href,a)}})();const De="https://khylhbikapjffnbvnjgb.supabase.co",Ne="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtoeWxoYmlrYXBqZmZuYnZuamdiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NTg0OTQsImV4cCI6MjA3NDAzNDQ5NH0.B0kO-Yy-sLYcF7rHM1I5E-SdYI_fh_4uALH7N13hxoM",S="eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI2Y2QyMWU2NDIxNDAwNTdjZDYzNjJiZjI5ZjlhMzNkMiIsIm5iZiI6MTY5MTkzOTQxNi45OTUwMDAxLCJzdWIiOiI2NGQ4ZjI1ODAwMWJiZDAwYzZjN2FmZjYiLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.1iAwqbg9q-TXSi6Sb8DPXAAcw29zd02GJarwO7QodcU",u=window.supabase.createClient(De,Ne);let l=null,h=null,b=null,oe=null,H=null,q=[],_=1,E=1,k=[],T=[],G=null,A=null,x=null,re=!1,M=null,y=[],O=0,f=null,X=!1,p=!1;const g={elements:{},observers:new Map};document.addEventListener("DOMContentLoaded",function(){try{Re(),He(),Oe(),Ue()}catch(e){console.error("App initialization failed:",e),c("Application failed to load. Please refresh.","error")}});function He(){["auth-container","main-header","main-content","player-modal","video-frame","loading-screen","notification-container","movies-grid","tv-grid","mylist-grid","search-grid","hero-section","player-overlay","extension-popup","payment-modal","continue-watching-grid","continue-watching-row"].forEach(t=>{g.elements[t]=document.getElementById(t)})}function Oe(){if("IntersectionObserver"in window){const e=new IntersectionObserver(t=>{t.forEach(o=>{if(o.isIntersecting){const r=o.target;r.dataset.src&&(r.src=r.dataset.src,r.classList.remove("lazy"),e.unobserve(r))}})},{rootMargin:"100px 0px",threshold:.01});g.observers.set("images",e)}}function Ue(){const e=new MutationObserver(t=>{t.forEach(o=>{if(o.type==="attributes"&&o.attributeName==="class"){const r=g.elements["player-modal"],n=g.elements["payment-modal"];r&&r.classList.contains("active")||n&&n.classList.contains("active")?(document.body.style.overflow="hidden",re=!0):(document.body.style.overflow="",re=!1)}})});g.elements["player-modal"]&&e.observe(g.elements["player-modal"],{attributes:!0,attributeFilter:["class"]}),g.elements["payment-modal"]&&e.observe(g.elements["payment-modal"],{attributes:!0,attributeFilter:["class"]})}async function Fe(e){try{const{data:t,error:o}=await u.from("allowed_users").select("email, approved, expiry_date").eq("email",e).single();return o&&o.code!=="PGRST116"?(console.error("Error checking allowed users:",o),{allowed:!1,reason:"error"}):t?t.approved!==!0?{allowed:!1,reason:"not_approved"}:t.expiry_date&&new Date(t.expiry_date)<new Date?{allowed:!1,reason:"expired"}:{allowed:!0,expiryDate:t.expiry_date}:{allowed:!1,reason:"not_found"}}catch(t){return console.error("Unexpected error checking allowed users:",t),{allowed:!1,reason:"error"}}}function Re(){try{Je(),ot(),rt(),nt(),at(),st(),ze(),tt(),We(),je(),Ct(),Yt(),ye()}catch(e){console.error("App initialization error:",e),c("Error initializing application","error")}}function ze(){const e=document.getElementById("payment-modal"),t=document.querySelectorAll("#open-payment-modal, #subscribe-link, #pay-now-btn"),o=document.getElementById("payment-close"),r=e==null?void 0:e.querySelector(".payment-overlay"),n=document.getElementById("submit-transaction-btn"),a=document.getElementById("transaction-id-input");t.forEach(s=>{s==null||s.addEventListener("click",i=>{i.preventDefault(),w()})}),o==null||o.addEventListener("click",W),r==null||r.addEventListener("click",W),n&&a&&n.addEventListener("click",async()=>{const s=a.value.trim();if(!s){c("Please enter a transaction ID","error");return}if(!l){c("Please log in first","error");return}n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Submitting...';try{const{error:i}=await u.from("pending_payments").insert({user_email:l.email,transaction_id:s,status:"pending",created_at:new Date().toISOString()});if(i)throw i;c("Transaction ID submitted! We'll verify your payment soon.","success"),a.value="",W()}catch(i){console.error("Error submitting transaction:",i),c("Failed to submit transaction ID. Please try again.","error")}finally{n.disabled=!1,n.innerHTML='<i class="fas fa-check"></i> Submit'}}),document.addEventListener("keydown",s=>{s.key==="Escape"&&e&&e.classList.contains("active")&&W()})}function w(){const e=document.getElementById("payment-modal");e&&(e.classList.add("active"),setTimeout(()=>{e.classList.add("show")},50))}function W(){const e=document.getElementById("payment-modal");e&&(e.classList.remove("show"),setTimeout(()=>{e.classList.remove("active")},300))}function je(){const e=document.getElementById("extension-popup"),t=document.getElementById("install-extension-btn"),o=document.getElementById("close-extension-popup");t&&t.addEventListener("click",()=>{window.open("https://chromewebstore.google.com/detail/bkkbcggnhapdmkeljlodobbkopceiche?utm_source=item-share-cb","_blank")}),o&&o.addEventListener("click",()=>{me()}),document.addEventListener("keydown",r=>{r.key==="Escape"&&e&&e.classList.contains("active")&&me()})}function Ye(){const e=document.getElementById("extension-popup");e&&(e.classList.add("active"),setTimeout(()=>{e.classList.add("show")},50))}function me(){const e=document.getElementById("extension-popup");e&&(e.classList.remove("show"),setTimeout(()=>{e.classList.remove("active")},300))}function We(){const e=document.getElementById("hero-section");e&&(e.addEventListener("mouseenter",()=>{f&&(clearInterval(f),f=null,X=!0)}),e.addEventListener("mouseleave",()=>{X&&y.length>=2&&(Z(),X=!1)}))}function Je(){var e,t,o,r;(e=document.getElementById("show-signup"))==null||e.addEventListener("click",n=>{n.preventDefault(),j("signin-form","signup-form")}),(t=document.getElementById("show-signin"))==null||t.addEventListener("click",n=>{n.preventDefault(),j("signup-form","signin-form")}),(o=document.getElementById("show-reset"))==null||o.addEventListener("click",n=>{n.preventDefault(),j("signin-form","reset-form")}),(r=document.getElementById("back-signin"))==null||r.addEventListener("click",n=>{n.preventDefault(),j("reset-form","signin-form")}),K("signup-form",Ge),K("signin-form",Ve),K("reset-form",Ze)}function K(e,t){var r;const o=(r=document.getElementById(e))==null?void 0:r.querySelector("form");o&&o.addEventListener("submit",t)}async function Ge(e){e.preventDefault();const t=e.target.querySelector('button[type="submit"]'),o=t.textContent;t.textContent="Creating Account...",t.disabled=!0;try{const r=document.getElementById("signup-email").value,n=document.getElementById("signup-password").value,a=document.getElementById("signup-confirm").value;if(n!==a){c("Passwords do not match","error");return}if(n.length<6){c("Password must be at least 6 characters","error");return}const{data:s,error:i}=await u.auth.signUp({email:r,password:n,options:{emailRedirectTo:window.location.origin+"/index.html"}});i?c(i.message,"error"):(c("Sign up successful! Please check your email to confirm your account.","success"),j("signup-form","signin-form"))}catch{c("Unexpected error during signup","error")}finally{t.textContent=o,t.disabled=!1}}async function Ve(e){e.preventDefault();const t=e.target.querySelector('button[type="submit"]'),o=t.textContent;t.textContent="Signing In...",t.disabled=!0;try{const r=document.getElementById("signin-email").value,n=document.getElementById("signin-password").value,{data:a,error:s}=await u.auth.signInWithPassword({email:r,password:n});if(s){c(s.message,"error");return}const i=a==null?void 0:a.user;if(!i){c("Sign-in did not return a user object.","error");return}if(!await ne(i))return;c("Signed in successfully!","success"),await ye()}catch(r){console.error(r),c("Unexpected error during signin","error")}finally{t.textContent=o,t.disabled=!1}}async function Ze(e){e.preventDefault();const t=e.target.querySelector('button[type="submit"]'),o=t.textContent;t.textContent="Sending Reset Link...",t.disabled=!0;try{const r=document.getElementById("reset-email").value,{error:n}=await u.auth.resetPasswordForEmail(r);n?c(n.message,"error"):c("Reset link sent to your email!","success")}catch{c("Unexpected error during password reset","error")}finally{t.textContent=o,t.disabled=!1}}let I=null,J=null;function ve(){const e="nf_device_id";let t=localStorage.getItem(e);if(!t){try{t=crypto.randomUUID()}catch{t=Date.now().toString(36)+Math.random().toString(36).slice(2)}localStorage.setItem(e,t)}return t}async function ne(e){const t=ve();try{const{data:o,error:r}=await u.from("active_sessions").select("*").eq("user_id",e.id).maybeSingle();return r&&console.error("Error checking active_sessions:",r),o&&o.is_active&&o.device_id&&o.device_id!==t?(await u.auth.signOut(),c("Account already active on another device. Please sign out there first.","error"),!1):(await u.from("active_sessions").upsert({user_id:e.id,device_id:t,is_active:!0,session_flag:"S",last_heartbeat:new Date().toISOString()},{returning:"minimal"}),Xe(e.id,t),Qe(e.id,t),!0)}catch(o){return console.error("registerSessionForUser error",o),!1}}function Qe(e,t){se(),J=setInterval(async()=>{try{await u.from("active_sessions").upsert({user_id:e,device_id:t,last_heartbeat:new Date().toISOString()},{returning:"minimal"})}catch(o){console.error("heartbeat error",o)}},6e4)}function se(){J&&(clearInterval(J),J=null)}function Xe(e,t){if(I){try{u.removeChannel(I)}catch{}I=null}const o=`session-channel-${e}`;I=u.channel(o).on("postgres_changes",{event:"*",schema:"public",table:"active_sessions",filter:`user_id=eq.${e}`},r=>{Ke(r,t)}).subscribe(r=>{})}function he(){if(I){try{u.removeChannel(I)}catch{try{I.unsubscribe()}catch{}}I=null}}async function Ke(e,t){try{const o=e.eventType||e.event,r=e.new,n=e.old,a=r||n;if(!a)return;if(o==="DELETE"){n.device_id===t&&await ee("Your session was ended (deleted) – you have been signed out.");return}if(a.is_active===!1||a.session_flag&&a.session_flag.toUpperCase()==="N"){await ee("Your session was disabled by admin – you have been signed out.");return}if(a.device_id&&a.device_id!==t){await ee("Your account was used on another device – signed out here.");return}}catch(o){console.error("handleSessionChange error",o)}}async function ee(e){se(),he();try{await u.auth.signOut()}catch(t){console.warn("force signout supabase.auth.signOut failed",t)}c(e,"warning"),V()}async function et(e){try{const t=ve();await u.from("active_sessions").upsert({user_id:e.id,device_id:t,is_active:!1,session_flag:"N",last_heartbeat:new Date().toISOString()},{returning:"minimal"})}catch(t){console.error("endSessionForUser error",t)}finally{se(),he()}}function tt(){var e;(e=document.getElementById("logout-link"))==null||e.addEventListener("click",async t=>{t.preventDefault();try{f&&(clearInterval(f),f=null);const o=l;o&&await et(o),await u.auth.signOut(),l=null,k=[],T=[],y=[],O=0,p=!1,c("Signed out successfully!","success"),V()}catch(o){console.error(o),c("Error signing out","error")}})}function ot(){document.querySelectorAll(".nav-link").forEach(e=>{e.addEventListener("click",P(t=>{t.preventDefault(),document.querySelectorAll(".nav-link").forEach(n=>n.classList.remove("active")),e.classList.add("active"),document.querySelectorAll(".content-section").forEach(n=>n.classList.remove("active"));const o=document.getElementById(`${e.dataset.section}-section`),r=document.getElementById("hero-section");o&&(o.classList.add("active"),r&&(e.dataset.section==="about"?(r.classList.add("hide-on-about"),f&&(clearInterval(f),f=null)):(r.classList.remove("hide-on-about"),e.dataset.section==="home"&&y.length>=2&&(f&&(clearInterval(f),f=null),setTimeout(()=>{Z()},500)))),e.dataset.section!=="home"&&f&&(clearInterval(f),f=null),ce(e.dataset.section))},150))})}function rt(){document.querySelectorAll(".genre-btn").forEach(e=>{e.addEventListener("click",P(()=>{const t=document.querySelector(".content-section.active");if(!t)return;const o=t.id,r=e.dataset.genre;document.querySelectorAll(".genre-btn").forEach(n=>n.classList.remove("active")),e.classList.add("active"),o==="movies-section"?ke(r):o==="tv-section"?Se(r):o==="bollywood-section"&&_e(r)},200))})}function nt(){var t;const e=document.getElementById("main-search-input");e&&(e.addEventListener("input",o=>{clearTimeout(G),G=setTimeout(()=>{kt(o.target.value.trim())},800)}),(t=document.getElementById("clear-search"))==null||t.addEventListener("click",()=>{e.value="",be()}))}function at(){var e;(e=document.getElementById("player-close"))==null||e.addEventListener("click",ue)}function st(){var t,o;(t=document.getElementById("account-link"))==null||t.addEventListener("click",r=>{r.preventDefault();const n=document.getElementById("account-modal");n&&(n.classList.add("active"),it())}),(o=document.getElementById("account-close"))==null||o.addEventListener("click",()=>{const r=document.getElementById("account-modal");r&&r.classList.remove("active")});const e=document.getElementById("account-modal");e&&e.addEventListener("click",r=>{r.target===e&&e.classList.remove("active")})}function j(e,t){const o=document.getElementById(e),r=document.getElementById(t);!o||!r||(o.classList.add("fade-out"),setTimeout(()=>{o.classList.remove("active","fade-out"),r.classList.add("active","slide-in-right"),setTimeout(()=>{r.classList.remove("slide-in-right")},400)},150))}function P(e,t){let o;return function(...n){const a=()=>{clearTimeout(o),e(...n)};clearTimeout(o),o=setTimeout(a,t)}}async function ye(){try{const{data:e,error:t}=await u.auth.getUser(),o=e==null?void 0:e.user,r=g.elements["loading-screen"];if(r&&(r.classList.add("fade-out"),setTimeout(()=>{r.style.display="none"},500)),o){l=o;const n=await Fe(o.email);if(p=n.allowed,console.log("User loaded:",{email:o.email,isUserApproved:p,reason:n.reason}),!n.allowed){await ne(o),await pe(),await ae(),await fe(),lt(n.reason);return}await ne(o),await pe(),await ae(),await dt(n.expiryDate),await fe(),ct(),await qt(o.email)&&setTimeout(()=>{At()},800),setTimeout(()=>{Ye()},1e3)}else l=null,p=!1,V()}catch(e){console.error("Error loading user:",e),V(),c("Error loading user. Please refresh.","error")}}async function fe(){if(l)try{const{data:e,error:t}=await u.from("user_profiles").select("avatar_url").eq("user_id",l.id).single();if(t&&t.code!=="PGRST116"){console.error("Error loading profile:",t);return}if(e&&e.avatar_url){const o=document.querySelector(".user-avatar");o&&(o.src=e.avatar_url+"?t="+new Date().getTime())}}catch(e){console.error("Error loading user profile and avatar:",e)}}function it(){const e=document.getElementById("account-email"),t=document.getElementById("account-member-since"),o=document.getElementById("subscription-status-text");if(l&&(Pt(),e&&(e.textContent=l.email),t&&(t.textContent=new Date(l.created_at).toLocaleDateString()),o)){const r=p?"Active":"Payment Required",n=p?"active":"pending";o.textContent=r,o.className=`subscription-status ${n}`}}function ct(){const{"auth-container":e,"main-header":t,"main-content":o}=g.elements;e&&(e.style.display="none"),t&&(t.style.display="flex"),o&&(o.style.display="block");const r=document.getElementById("settings-email");r&&l&&(r.textContent=l.email);const n=document.getElementById("settings-member-since");if(n&&l){const i=new Date(l.created_at);n.textContent=i.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}const a=document.getElementById("settings-subscription-status");a&&(a.textContent="Active",a.className="subscription-status active"),document.querySelectorAll(".nav-link").forEach(i=>{i.style.display="block"});const s=document.getElementById("hero-section");s&&s.classList.remove("hide-on-about"),f&&(clearInterval(f),f=null),ce("home")}function lt(e){const{"auth-container":t,"main-header":o,"main-content":r}=g.elements;t&&(t.style.display="none"),o&&(o.style.display="flex"),r&&(r.style.display="block");const n=document.getElementById("settings-email");n&&l&&(n.textContent=l.email);const a=document.getElementById("settings-member-since");if(a&&l){const d=new Date(l.created_at);a.textContent=d.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}const s=document.getElementById("settings-subscription-status");s&&(e==="not_found"||e==="not_approved"?(s.textContent="Payment Required",s.className="subscription-status pending"):e==="expired"&&(s.textContent="Subscription expired",s.className="subscription-status expired")),e==="not_found"||e==="not_approved"?c("Please complete payment to access all content","warning"):e==="expired"&&c("Your subscription has expired. Please renew.","warning"),document.querySelectorAll(".nav-link").forEach(d=>{d.style.display="block"});const i=document.getElementById("hero-section");i&&i.classList.remove("hide-on-about"),f&&(clearInterval(f),f=null),ce("home")}async function dt(e){const t=document.getElementById("subscription-status-text");if(!t||!e)return;const o=new Date(e),n=Math.ceil((o-new Date)/(1e3*60*60*24));n>0?(t.textContent=`${n} day${n!==1?"s":""} remaining`,t.className="subscription-status active"):(t.textContent="Subscription expired",t.className="subscription-status expired")}async function pe(){if(l)try{const{data:e,error:t}=await u.from("user_bookmarks").select("*").eq("user_id",l.id).order("added_at",{ascending:!1});if(t){if(t.code==="42P01"||t.message.includes("does not exist")){c("Failed to load bookmarks. Table may need to be created.","warning"),k=[];return}throw t}k=e.map(o=>({id:o.media_id,media_type:o.media_type,title:o.title,name:o.title,poster_path:o.poster_path,vote_average:o.vote_average||0,release_date:o.release_date||"",first_air_date:o.first_air_date||""}))}catch(e){console.error("Error loading bookmarks:",e),c("Failed to load bookmarks. Table may need to be created.","warning"),k=[]}}async function ae(){if(l)try{const{data:e,error:t}=await u.from("continue_watching").select("*").eq("user_id",l.id).eq("completed",!1).gte("watch_progress",60).order("last_watched_at",{ascending:!1}).limit(12);if(t){if(t.code==="42P01"||t.message.includes("does not exist")){console.log("Continue watching table doesn't exist yet"),T=[];return}throw t}T=e.map(r=>({id:r.media_id,media_type:r.media_type,title:r.title,name:r.title,poster_path:r.poster_path,watch_progress:r.watch_progress,total_duration:r.total_duration,progress_percentage:r.total_duration>0?r.watch_progress/r.total_duration*100:0,season:r.season||1,episode:r.episode||1}));const o=document.getElementById("continue-watching-row");o&&(o.style.display=T.length>0?"block":"none")}catch(e){console.error("Error loading continue watching:",e),T=[]}}function ie(){const e=g.elements["continue-watching-grid"];if(!e)return;for(;e.firstChild;)e.removeChild(e.firstChild);if(T.length===0){const o=document.getElementById("continue-watching-row");o&&(o.style.display="none");return}const t=document.createDocumentFragment();T.forEach((o,r)=>{const n=ut(o,r);t.appendChild(n)}),e.appendChild(t),Le(e)}function ut(e,t){const o=e.title||e.name,r=Math.min(e.progress_percentage||0,100),n=document.createElement("div");n.className="media-card continue-watching-card hover-glow",n.style.animationDelay=`${t*50}ms`,n.tabIndex=0;const a=p?"fa-play":"fa-lock",s=p?"Continue watching":"Premium access required";n.innerHTML=`
    <div class="card-image-container">
      <button class="remove-continue-btn" 
              data-id="${e.id}"
              title="Remove from Continue Watching"
              aria-label="Remove from continue watching">
        <i class="fas fa-times"></i>
      </button>
      <img 
        data-src="https://image.tmdb.org/t/p/w500${e.poster_path}" 
        alt="${o}"
        class="lazy"
        loading="lazy"
        onerror="this.src='https://via.placeholder.com/500x750?text=No+Image'"
      >
      <div class="card-overlay">
        <button class="play-btn hover-glow" title="${s}">
          <i class="fas ${a}"></i>
        </button>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${r}%"></div>
      </div>
    </div>
    <div class="card-info">
      <h3 class="card-title">${o}</h3>
      <div class="card-meta">
        <span class="continue-progress">${Math.round(r)}% watched</span>
        <span>${e.media_type==="tv"?"TV":"Movie"}</span>
      </div>
    </div>
  `;const i=n.querySelector(".play-btn");i&&i.addEventListener("click",m=>{m.stopPropagation(),p?U({...e,media_type:e.media_type,resumeSeason:e.season,resumeEpisode:e.episode}):(c("Premium access required to watch content","error"),w())}),n.addEventListener("click",P(()=>{p?U({...e,media_type:e.media_type,resumeSeason:e.season,resumeEpisode:e.episode}):(c("Premium access required to watch content","error"),w())},300));const d=n.querySelector(".remove-continue-btn");return d&&d.addEventListener("click",m=>{m.stopPropagation(),mt(e.id)}),n}async function mt(e){if(l)try{const{error:t}=await u.from("continue_watching").delete().eq("user_id",l.id).eq("media_id",e);if(t)throw t;T=T.filter(o=>o.id!==e),ie(),c("Removed from Continue Watching","success")}catch(t){console.error("Error removing from continue watching:",t),c("Failed to remove item","error")}}async function we(e,t,o){if(!(!l||!e||t<60))try{const n=(o>0?t/o*100:0)>90,{error:a}=await u.from("continue_watching").upsert({user_id:l.id,media_id:e.id,media_type:e.media_type,title:e.title||e.name,poster_path:e.poster_path,watch_progress:Math.floor(t),total_duration:Math.floor(o),last_watched_at:new Date().toISOString(),completed:n,season:e.media_type==="tv"?_:null,episode:e.media_type==="tv"?E:null},{onConflict:"user_id,media_id",returning:"minimal"});if(a)throw a}catch(r){console.error("Error updating watch progress:",r)}}function V(){const{"auth-container":e,"main-header":t,"main-content":o}=g.elements;e&&(e.style.display="flex"),t&&(t.style.display="none"),o&&(o.style.display="none")}function be(){var e,t;document.querySelectorAll(".content-section").forEach(o=>o.classList.remove("active")),(e=document.getElementById("home-section"))==null||e.classList.add("active"),document.querySelectorAll(".nav-link").forEach(o=>o.classList.remove("active")),(t=document.querySelector('[data-section="home"]'))==null||t.classList.add("active")}function ce(e){switch(Ee(e),e){case"home":Promise.all([ft(),vt(),ht(),yt()]).then(()=>{ie()}).finally(()=>{C(e);const t=document.getElementById("home-section");t&&t.classList.contains("active")&&y.length>=2&&(f&&(clearInterval(f),f=null),setTimeout(()=>{Z()},1e3))});break;case"movies":ke("all").finally(()=>C(e));break;case"tv":Se("all").finally(()=>C(e));break;case"bollywood":_e("all").finally(()=>C(e));break;case"mylist":Be(),C(e);break;case"about":C(e),Me();break}}async function _e(e){try{let t="https://api.themoviedb.org/3/discover/movie?sort_by=vote_average.desc&vote_count.gte=100&with_original_language=hi";e!=="all"&&(t+=`&with_genres=${e}`);const o=await L(t,{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json;charset=utf-8"}});if(!o.ok)throw new Error(`HTTP ${o.status}`);const n=(await o.json()).results.filter(a=>!a.adult&&a.original_language==="hi"&&a.vote_count>=100);$(n,"bollywood-grid")}catch(t){console.error("Error loading Bollywood movies:",t),c("Error loading Bollywood movies","error")}}function Ee(e){const t=document.getElementById(`${e}-section`);if(t&&!t.querySelector(".loading-indicator")){const o=document.createElement("div");o.className="loading-indicator",o.innerHTML='<div class="spinner"></div><p>Loading content...</p>',t.appendChild(o)}}function C(e){const t=document.getElementById(`${e}-section`),o=t==null?void 0:t.querySelector(".loading-indicator");o&&o.remove()}async function L(e,t={},o=1e4){const r=new AbortController,n=setTimeout(()=>r.abort(),o);try{const a=await fetch(e,{...t,signal:r.signal});return clearTimeout(n),a}catch(a){throw clearTimeout(n),a}}async function ft(){try{const e=await L("https://api.themoviedb.org/3/movie/popular?language=en-US&page=1",{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json;charset=utf-8"}});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json(),o=new Date().getFullYear();y=t.results.filter(n=>{const a=n.release_date?parseInt(n.release_date.split("-")[0]):0;return n.adult===!1&&n.vote_average>=7&&a>=2020}).slice(0,5),y.length>0&&(O=Math.floor(Math.random()*y.length),M=y[O],le(M),y.length>=2&&(f&&(clearInterval(f),f=null),setTimeout(()=>{Z()},500)))}catch(e){console.error("Error loading featured content:",e)}}function Z(){f||y.length<2||(f=setInterval(()=>{pt()},5e3))}function pt(){if(y.length<2)return;const e=document.querySelector(".hero-content"),t=document.querySelector(".hero-backdrop");e&&(e.style.opacity="0"),t&&(t.style.opacity="0"),setTimeout(()=>{O=(O+1)%y.length,M=y[O],le(M),e&&(e.style.opacity="1"),t&&(t.style.opacity="0.3")},800)}function le(e){const t=document.querySelector(".hero-backdrop"),o=document.getElementById("hero-title"),r=document.getElementById("hero-meta"),n=document.getElementById("hero-description"),a=document.getElementById("hero-watch-btn"),s=document.getElementById("hero-bookmark-btn-new");if(t&&e.backdrop_path&&(t.style.backgroundImage=`url(https://image.tmdb.org/t/p/original${e.backdrop_path})`,t.style.opacity="0.3"),o&&(o.textContent=e.title||e.name),r){const i=e.vote_average?e.vote_average.toFixed(1):"N/A",d=(e.release_date||e.first_air_date||"").split("-")[0],m=e.media_type==="tv"?"TV Show":"Movie",v=e.genre_ids?e.genre_ids.slice(0,2).map(D=>gt(D)).filter(Boolean).join(", "):"Action, Adventure";r.innerHTML=`
      <span class="hero-rating"><i class="fas fa-star"></i> ${i}</span>
      <span>${d||"N/A"}</span>
      <span>${v||m}</span>
    `}if(n){const i=e.overview||"No description available";n.textContent=i.length>250?i.substring(0,250)+"...":i}if(a&&(p?(a.innerHTML='<i class="fas fa-play"></i> Watch Now',a.onclick=()=>{U({...e,media_type:e.media_type||"movie"})}):(a.innerHTML='<i class="fas fa-lock"></i> Premium Required',a.onclick=()=>{c("Subscribe to unlock premium content","error"),w()})),s&&l){const i=k.some(v=>v.id===e.id),d=s.querySelector("i"),m=s.querySelector("span");s.classList.add("show"),i?(d.className="fas fa-bookmark",s.classList.add("bookmarked"),m&&(m.textContent="Remove from List")):(d.className="far fa-bookmark",s.classList.remove("bookmarked"),m&&(m.textContent="Add to List")),s.onclick=()=>{p?de(e,e.media_type||"movie",s):(c("Subscribe to use bookmark feature","error"),w())}}else s&&s.classList.remove("show")}function gt(e){return{28:"Action",12:"Adventure",16:"Animation",35:"Comedy",80:"Crime",99:"Documentary",18:"Drama",10751:"Family",14:"Fantasy",36:"History",27:"Horror",10402:"Music",9648:"Mystery",10749:"Romance",878:"Sci-Fi",10770:"TV Movie",53:"Thriller",10752:"War",37:"Western",10759:"Action",10765:"Sci-Fi"}[e]||""}async function vt(){try{const e=await L("https://api.themoviedb.org/3/trending/all/week",{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json;charset=utf-8"}});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();$(t.results.slice(0,12),"trending-grid")}catch(e){console.error("Error loading trending:",e),c("Error loading trending content","error")}}async function ht(){try{const e=await L("https://api.themoviedb.org/3/movie/popular",{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json;charset=utf-8"}});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();$(t.results.slice(0,12),"popular-movies-grid")}catch(e){console.error("Error loading popular movies:",e),c("Error loading popular movies","error")}}async function yt(){try{const e=await L("https://api.themoviedb.org/3/tv/popular",{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json;charset=utf-8"}});if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();$(t.results.slice(0,12),"popular-tv-grid")}catch(e){console.error("Error loading popular TV shows:",e),c("Error loading popular TV shows","error")}}async function ke(e){try{let t="https://api.themoviedb.org/3/discover/movie?sort_by=popularity.desc";e!=="all"&&(t+=`&with_genres=${e}`);const o=await L(t,{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json;charset=utf-8"}});if(!o.ok)throw new Error(`HTTP ${o.status}`);const r=await o.json();$(r.results,"movies-grid")}catch(t){console.error("Error loading movies:",t),c("Error loading movies","error")}}async function Se(e){try{let t="https://api.themoviedb.org/3/discover/tv?sort_by=popularity.desc";e!=="all"&&(t+=`&with_genres=${e}`);const o=await L(t,{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json;charset=utf-8"}});if(!o.ok)throw new Error(`HTTP ${o.status}`);const r=await o.json();$(r.results,"tv-grid")}catch(t){console.error("Error loading TV shows:",t),c("Error loading TV shows","error")}}function $(e,t){const o=document.getElementById(t);if(!o)return;for(;o.firstChild;)o.removeChild(o.firstChild);if(!e||e.length===0){o.innerHTML="<p class='no-content'>No content available</p>";return}const r=document.createDocumentFragment();e.forEach((n,a)=>{const s=n.media_type||(n.first_air_date?"tv":"movie"),i=wt(n,s,a);r.appendChild(i)}),o.appendChild(r),Le(o)}function wt(e,t,o){const r=e.title||e.name,n=(e.release_date||e.first_air_date||"").split("-")[0],a=e.vote_average?e.vote_average.toFixed(1):"N/A",s=k.some(B=>B.id===e.id),i=p?"fa-play":"fa-lock",d=p?`Play ${r}`:"Premium access required",m=document.createElement("div");m.className="media-card hover-glow",m.style.animationDelay=`${o*50}ms`,m.tabIndex=0;const v=l&&p?`
    <button class="bookmark-btn ${s?"bookmarked":""}" 
            data-id="${e.id}"
            title="${s?"Remove from List":"Add to List"}"
            aria-label="${s?"Remove from bookmarks":"Add to bookmarks"}">
      <i class="${s?"fas":"far"} fa-bookmark"></i>
    </button>
  `:"";m.innerHTML=`
    <div class="card-image-container">
      ${v}
      <img 
        data-src="https://image.tmdb.org/t/p/w500${e.poster_path}" 
        alt="${r}"
        class="lazy"
        loading="lazy"
        onerror="this.src='https://via.placeholder.com/500x750?text=No+Image'"
      >
      <div class="card-overlay">
        <button class="play-btn hover-glow" title="${d}">
          <i class="fas ${i}"></i>
        </button>
      </div>
    </div>
    <div class="card-info">
      <h3 class="card-title">${r}</h3>
      <div class="card-meta">
        <span class="card-rating">
          <i class="fas fa-star"></i>
          ${a}
        </span>
        <span>${n}</span>
        <span>${t==="tv"?"TV":"Movie"}</span>
      </div>
    </div>
  `;const D=m.querySelector(".play-btn");D&&D.addEventListener("click",B=>{B.stopPropagation(),p?U({...e,media_type:t}):(c("Premium access required to watch content","error"),w())}),m.addEventListener("click",P(()=>{p?U({...e,media_type:t}):(c("Premium access required to watch content","error"),w())},300)),m.addEventListener("keypress",B=>{(B.key==="Enter"||B.key===" ")&&(B.preventDefault(),p?U({...e,media_type:t}):(c("Premium access required to watch content","error"),w()))});const N=m.querySelector(".bookmark-btn");return N&&N.addEventListener("click",B=>{B.stopPropagation(),p?(bt(N),de(e,t,N)):(c("Subscribe to use bookmark feature","error"),w())}),m}function Le(e){const t=g.observers.get("images");t&&e.querySelectorAll("img.lazy").forEach(o=>{t.observe(o)})}function bt(e){e.style.transform="scale(0.9)",setTimeout(()=>{e.style.transform="scale(1)"},150)}function Be(){const e=document.getElementById("mylist-grid");if(e){if(k.length===0){e.innerHTML=`
      <div class="no-content">
        <i class="fas fa-bookmark"></i>
        <p>No items in your list yet. Add some movies or TV shows!</p>
      </div>
    `;return}$(k,"mylist-grid")}}function de(e,t,o){var a;if(!l){c("Please log in to manage your list","error");return}if(!p){c("Subscribe to use bookmark feature","error"),w();return}const r=k.findIndex(s=>s.id===e.id),n=o.querySelector("i");r>-1?(k.splice(r,1),c("Removed from your list","success"),Et(e.id),n&&(n.className="far fa-bookmark"),o.classList.remove("bookmarked"),o.title="Add to List"):(k.push({...e,media_type:t}),c("Added to your list","success"),_t(e,t),n&&(n.className="fas fa-bookmark"),o.classList.add("bookmarked"),o.title="Remove from List"),(a=document.getElementById("mylist-section"))!=null&&a.classList.contains("active")&&Be(),M&&M.id===e.id&&le(M)}async function _t(e,t){try{const{error:o}=await u.from("user_bookmarks").insert({user_id:l.id,media_id:e.id,media_type:t,title:e.title||e.name,poster_path:e.poster_path,vote_average:e.vote_average,release_date:e.release_date||null,first_air_date:e.first_air_date||null,added_at:new Date().toISOString()});if(o)throw o}catch(o){console.error("Error adding bookmark to Supabase:",o)}}async function Et(e){try{const{error:t}=await u.from("user_bookmarks").delete().eq("user_id",l.id).eq("media_id",e);if(t)throw t}catch(t){console.error("Error removing bookmark from Supabase:",t)}}async function kt(e){var t;if(!e.trim()){be();return}try{Ee("search");const o=await L(`https://api.themoviedb.org/3/search/multi?query=${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json;charset=utf-8"}});if(!o.ok)throw new Error(`HTTP ${o.status}`);const n=(await o.json()).results.filter(a=>!a.adult&&(a.media_type==="movie"||a.media_type==="tv")&&a.poster_path);l&&St(e),document.querySelectorAll(".content-section").forEach(a=>a.classList.remove("active")),(t=document.getElementById("search-section"))==null||t.classList.add("active"),$(n,"search-grid"),setTimeout(()=>{var s;const a=document.getElementById("search-section");if(a){const i=((s=document.querySelector(".main-header"))==null?void 0:s.offsetHeight)||80,d=a.offsetTop-i-20;window.scrollTo({top:d,behavior:"smooth"})}},100)}catch(o){console.error("Error searching:",o),c("Error performing search","error")}finally{C("search")}}async function St(e){try{const{error:t}=await u.from("user_search_history").insert({user_id:l.id,query:e,searched_at:new Date().toISOString()});if(t)throw t}catch(t){console.error("Error recording search history:",t)}}async function Lt(e,t=null,o=null,r=0){try{const{error:n}=await u.from("user_watch_history").insert({user_id:l.id,media_id:e.id,media_type:e.media_type,title:e.title||e.name,season:t,episode:o,duration:r,watched_at:new Date().toISOString()});if(n)throw n}catch(n){console.error("Error recording watch history:",n)}}function U(e){if(!l){c("Please log in to stream content","error");return}if(!p){c("Premium access required to watch content. Please subscribe to continue.","error"),w();return}h=e.media_type,b=e.id,oe=e.title||e.name,H=e,document.getElementById("player-title").textContent=oe,document.getElementById("player-description").textContent=e.overview||"No description available";const t=document.getElementById("player-rating-value"),o=document.getElementById("player-year"),r=document.getElementById("player-type");if(t&&(t.textContent=e.vote_average?e.vote_average.toFixed(1):"N/A"),o){const s=(e.release_date||e.first_air_date||"").split("-")[0];o.textContent=s||"N/A"}r&&(r.textContent=h==="tv"?"TV Show":"Movie");const n=document.getElementById("tv-controls");n&&(n.style.display=h==="tv"?"flex":"none"),h==="tv"&&(_=e.resumeSeason||1,E=e.resumeEpisode||1,It(b)),Te(),Ie(),Q(0),A=new Date,x&&clearInterval(x),x=setInterval(()=>{Bt()},3e4);const a=g.elements["player-modal"];a&&(a.classList.add("active"),setTimeout(()=>{a.classList.add("opened")},50))}function Bt(){if(!l||!H)return;const e=g.elements["video-frame"];if(!e||!e.src)return;const t=A?(new Date-A)/1e3:0,o=h==="movie"?7200:2700;t>60&&we(H,t,o)}function ue(){var t;if(A&&l&&H){const r=(new Date-A)/1e3;r>30&&(Lt({id:b,media_type:h,title:oe},h==="tv"?_:null,h==="tv"?E:null,r),we(H,r,h==="movie"?7200:2700),Rt(h,r,H.genre_ids))}Tt();const e=g.elements["player-modal"];e&&(e.classList.remove("opened"),setTimeout(()=>{e.classList.remove("active"),document.body.style.overflow=""},300)),(t=document.getElementById("home-section"))!=null&&t.classList.contains("active")&&ae().then(()=>ie())}function Tt(){x&&(clearInterval(x),x=null);const e=g.elements["video-frame"];e&&(e.src="about:blank"),h==="tv"&&(_=1,E=1),A=null}function Te(){h==="movie"?q=[{name:"Source 1",url:`https://111movies.com/movie/${b}`},{name:"Source 2",url:`https://player.videasy.net/movie/${b}`},{name:"Source 3",url:`https://vidsrc.xyz/embed/movie/${b}`},{name:"Source 4",url:`https://vidsrc.me/embed/movie/${b}`}]:h==="tv"&&(q=[{name:"Source 1",url:`https://111movies.com/tv/${b}/${_}/${E}`},{name:"Source 2",url:`https://player.videasy.net/tv/${b}/${_}/${E}`},{name:"Source 3",url:`https://vidsrc.xyz/embed/tv/${b}/${_}/${E}`},{name:"Source 4",url:`https://vidsrc.me/embed/tv/${b}/${_}/${E}`}])}function Ie(){const e=document.getElementById("source-buttons");e&&(e.innerHTML="",q.forEach((t,o)=>{const r=document.createElement("button");r.className="source-btn hover-glow",o===0&&r.classList.add("active"),r.textContent=t.name,r.style.animationDelay=`${o*100}ms`,r.addEventListener("click",P(()=>{document.querySelectorAll(".source-btn").forEach(n=>n.classList.remove("active")),r.classList.add("active"),Q(o)},200)),e.appendChild(r)}))}function Q(e){if(e<0||e>=q.length)return;const t=q[e],o=g.elements["video-frame"];if(!o)return;o.setAttribute("allow","autoplay; fullscreen; encrypted-media; picture-in-picture"),o.setAttribute("referrerpolicy","no-referrer-when-downgrade"),xe();let r=0;const n=2;function a(){o.onerror=()=>{r++,r<=n?(c(`Retrying ${t.name}... (${r}/${n})`,"warning"),setTimeout(a,1e3*r)):ge(e)},o.onload=()=>{$e()},o.src=t.url+(t.url.includes("?")?"&":"?")+"t="+Date.now()}const s=setTimeout(()=>{var i;o.src&&!((i=o.contentWindow)!=null&&i.length)&&ge(e)},1e4);o.addEventListener("load",()=>clearTimeout(s),{once:!0}),a()}function ge(e){$e();const t=(e+1)%q.length;t!==e?(c(`Trying ${q[t].name}...`,"warning"),setTimeout(()=>Q(t),1e3)):c("All sources failed. Please try again later.","error")}function xe(){const e=document.querySelector(".player-video-section");if(e&&!e.querySelector(".video-loading")){const t=document.createElement("div");t.className="video-loading",t.innerHTML=`
      <div class="video-spinner"></div>
      <p>Loading video source...</p>
    `,e.appendChild(t)}}function $e(){const e=document.querySelector(".video-loading");e&&e.remove()}async function It(e){try{const t=await L(`https://api.themoviedb.org/3/tv/${e}`,{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json;charset=utf-8"}});if(!t.ok)throw new Error(`HTTP ${t.status}`);const r=(await t.json()).seasons.filter(a=>a.season_number>0),n=document.getElementById("season-select");if(!n)return;n.innerHTML="",r.forEach(a=>{const s=document.createElement("option");s.value=a.season_number,s.textContent=`Season ${a.season_number}`,a.season_number===_&&(s.selected=!0),n.appendChild(s)}),n.addEventListener("change",P(a=>{_=parseInt(a.target.value),E=1,Ce()},300)),await xt(e,_)}catch(t){console.error("Error loading seasons:",t),c("Error loading seasons","error")}}async function xt(e,t){try{const o=await L(`https://api.themoviedb.org/3/tv/${e}/season/${t}`,{headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json;charset=utf-8"}});if(!o.ok)throw new Error(`HTTP ${o.status}`);const r=await o.json();$t(r.episodes)}catch(o){console.error("Error loading episodes:",o),c("Error loading episodes","error")}}function $t(e){const t=document.getElementById("episodes-list");if(!t)return;if(t.innerHTML="",!e||e.length===0){t.innerHTML="<p class='no-episodes'>No episodes available</p>";return}const o=document.createDocumentFragment();e.forEach((r,n)=>{const a=document.createElement("div");a.className=`episode-card hover-glow ${r.episode_number===E?"active":""}`,a.style.animationDelay=`${n*50}ms`,a.innerHTML=`
      <div class="episode-number">${r.episode_number}</div>
      <div class="episode-info">
        <div class="episode-title">${r.name||`Episode ${r.episode_number}`}</div>
        <div class="episode-meta">
          ${r.runtime?`${r.runtime}m • `:""}
          ${r.air_date?new Date(r.air_date).getFullYear():"TBA"}
        </div>
      </div>
    `,a.addEventListener("click",P(()=>{document.querySelectorAll(".episode-card").forEach(s=>s.classList.remove("active")),a.classList.add("active"),E=r.episode_number,Ce()},300)),o.appendChild(a)}),t.appendChild(o)}function Ce(){xe(),Te(),Ie(),Q(0),A=new Date}function c(e,t="success"){const o=document.getElementById("notification-container");if(!o)return;const r=document.createElement("div");r.className=`notification ${t} slide-in-right`,r.setAttribute("role","alert"),r.innerHTML=`
    <i class="notification-icon fas ${t==="success"?"fa-check-circle":t==="error"?"fa-exclamation-circle":"fa-exclamation-triangle"}"></i>
    <span>${e}</span>
    <button class="notification-close" aria-label="Close notification">
      <i class="fas fa-times"></i>
    </button>
  `,o.appendChild(r),setTimeout(()=>r.classList.add("show"),100);const n=setTimeout(()=>{te(r)},5e3);r.querySelector(".notification-close").addEventListener("click",()=>{clearTimeout(n),te(r)}),r.addEventListener("click",s=>{(s.target===r||s.target.closest(".notification-close"))&&(clearTimeout(n),te(r))})}function te(e){e.classList.add("fade-out"),setTimeout(()=>{e.parentNode&&e.remove()},300)}document.addEventListener("keydown",e=>{if(re)switch(e.key){case"Escape":ue();break}});let Y;window.addEventListener("scroll",()=>{Y||(Y=setTimeout(()=>{const e=g.elements["main-header"];e&&e.classList.toggle("scrolled",window.scrollY>50),Y=null},10))});window.addEventListener("beforeunload",()=>{x&&clearInterval(x),Y&&clearTimeout(Y),G&&clearTimeout(G),g.observers.forEach(e=>e.disconnect())});window.NekoFlix={closePlayer:ue,showNotification:c,toggleBookmark:(e,t)=>{const o=document.createElement("button");de(e,t,o)}};const F=document.getElementById("mobile-menu-toggle"),R=document.getElementById("mobile-nav-overlay"),z=document.querySelector(".main-nav");F&&R&&z&&(F.addEventListener("click",()=>{z.classList.toggle("active"),R.classList.toggle("active");const e=F.querySelector("i");z.classList.contains("active")?e.className="fas fa-times":e.className="fas fa-bars"}),R.addEventListener("click",()=>{z.classList.remove("active"),R.classList.remove("active");const e=F.querySelector("i");e.className="fas fa-bars"}),document.querySelectorAll(".main-nav .nav-link").forEach(e=>{e.addEventListener("click",()=>{if(window.innerWidth<=768){z.classList.remove("active"),R.classList.remove("active");const t=F.querySelector("i");t.className="fas fa-bars"}})}));function Ct(){const e=document.getElementById("about-subscribe-btn");e&&e.addEventListener("click",()=>{w()});const t=document.getElementById("back-to-home");t&&t.addEventListener("click",()=>{var r,n;const o=document.getElementById("main-header");o&&(o.style.display="flex"),document.body.classList.remove("about-page-active"),document.querySelectorAll(".content-section").forEach(a=>a.classList.remove("active")),(r=document.getElementById("home-section"))==null||r.classList.add("active"),document.querySelectorAll(".nav-link").forEach(a=>a.classList.remove("active")),(n=document.querySelector('[data-section="home"]'))==null||n.classList.add("active")}),Mt(),Me()}function Mt(){const e=document.querySelectorAll(".faq-item");e.forEach(t=>{t.querySelector(".faq-question").addEventListener("click",()=>{const r=t.classList.contains("active");e.forEach(n=>{n!==t&&n.classList.remove("active")}),r?t.classList.remove("active"):t.classList.add("active")})})}function Me(){const e={threshold:.1,rootMargin:"0px 0px -100px 0px"},t=new IntersectionObserver(r=>{r.forEach(n=>{n.isIntersecting&&(n.target.style.opacity="1",n.target.style.transform="translateY(0)")})},e);document.querySelectorAll(".about-section-block, .feature-card, .comparison-card, .step-card, .source-info-card").forEach(r=>{r.style.opacity="0",r.style.transform="translateY(30px)",r.style.transition="opacity 0.6s ease, transform 0.6s ease",t.observe(r)})}async function qt(e){try{const{data:t,error:o}=await u.from("special_users").select("email, enabled").eq("email",e.toLowerCase()).eq("enabled",!0).maybeSingle();return o?(console.error("Error checking special users:",o),!1):!!t}catch(t){return console.error("Unexpected error checking special users:",t),!1}}function At(){const e=document.createElement("div");e.className="heart-animation-container",e.innerHTML=`
    <div class="heart-animation-overlay"></div>
    <div class="heart-main-wrapper">
      <div class="heart-main">
        <svg viewBox="0 0 32 29.6" class="heart-svg">
          <path d="M23.6,0c-3.4,0-6.3,2.7-7.6,5.6C14.7,2.7,11.8,0,8.4,0C3.8,0,0,3.8,0,8.4c0,9.4,9.5,11.9,16,21.2
          c6.1-9.3,16-12.1,16-21.2C32,3.8,28.2,0,23.6,0z"/>
        </svg>
      </div>
      <div class="heart-particles"></div>
      <div class="heart-message">Its OUR Webiste!</div>
    </div>
  `,document.body.appendChild(e);const t=e.querySelector(".heart-particles");for(let o=0;o<30;o++){const r=document.createElement("div");r.className="heart-particle";const n=Math.PI*2*o/30,a=100+Math.random()*150,s=Math.cos(n)*a,i=Math.sin(n)*a,d=Math.random()*.3,m=1.5+Math.random()*.5;r.style.setProperty("--tx",`${s}px`),r.style.setProperty("--ty",`${i}px`),r.style.setProperty("--delay",`${d}s`),r.style.setProperty("--duration",`${m}s`),Math.random()>.5?r.innerHTML='<svg viewBox="0 0 32 29.6"><path d="M23.6,0c-3.4,0-6.3,2.7-7.6,5.6C14.7,2.7,11.8,0,8.4,0C3.8,0,0,3.8,0,8.4c0,9.4,9.5,11.9,16,21.2c6.1-9.3,16-12.1,16-21.2C32,3.8,28.2,0,23.6,0z"/></svg>':r.innerHTML='<svg viewBox="0 0 512 512"><path d="M256 0l47.4 143.5L448 143.5l-115.9 84.2L377.1 512 256 384.8 134.9 512l45-284.3L64 143.5h144.6z"/></svg>',t.appendChild(r)}setTimeout(()=>{e.classList.add("active")},100),setTimeout(()=>{e.classList.add("fadeout"),setTimeout(()=>{e.parentNode&&e.remove()},800)},4e3)}async function Pt(){if(l)try{let{data:e,error:t}=await u.from("user_profiles").select("*").eq("user_id",l.id).single();if(t&&t.code==="PGRST116"){const{data:r,error:n}=await u.from("user_profiles").insert({user_id:l.id,display_name:l.email.split("@")[0],created_at:new Date().toISOString()}).select().single();if(n)throw n;e=r}else if(t)throw t;await Ft(e);const o=document.getElementById("profile-favorite-genre");o&&e.favorite_genre&&(o.value=e.favorite_genre),Dt(e),await Ae(),await qe()}catch(e){console.error("Error loading user profile:",e),c("Failed to load profile data","error")}}function Dt(e){const t=document.getElementById("profile-display-name");t&&(t.value=e.display_name||"");const o=document.getElementById("profile-favorite-genre");o&&e.favorite_genre&&(o.value=e.favorite_genre,o.setAttribute("data-genre-value",e.favorite_genre));const r=document.getElementById("profile-avatar-display");r&&e.avatar_url&&(r.src=e.avatar_url);const n=document.querySelector(".user-avatar");n&&e.avatar_url&&(n.src=e.avatar_url);const a=document.getElementById("settings-email");a&&(a.textContent=l.email);const s=document.getElementById("settings-member-since");if(s){const d=new Date(e.created_at);s.textContent=d.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}const i=document.getElementById("settings-subscription-status");if(i){const d=p?"Active":"Payment Required",m=p?"active":"pending";i.textContent=d,i.className=`subscription-status ${m}`}}async function qe(){if(l)try{const{data:e,error:t}=await u.from("user_profiles").select("*").eq("user_id",l.id).single();if(t)throw t;const{count:o,error:r}=await u.from("user_bookmarks").select("*",{count:"exact",head:!0}).eq("user_id",l.id);if(r)throw r;const{count:n,error:a}=await u.from("user_badges").select("*",{count:"exact",head:!0}).eq("user_id",l.id);if(a)throw a;const s=Math.floor((e.total_watch_time||0)/3600),i=Math.floor((e.total_watch_time||0)%3600/60);document.getElementById("stat-watch-time").textContent=s>0?`${s}h ${i}m`:`${i}m`,document.getElementById("stat-movies").textContent=e.movies_watched||0,document.getElementById("stat-series").textContent=e.series_watched||0,document.getElementById("stat-bookmarks").textContent=o||0,document.getElementById("stat-streak").textContent=e.consecutive_days||0,document.getElementById("stat-badges").textContent=n||0}catch(e){console.error("Error loading user stats:",e)}}async function Ae(){if(l)try{const{data:e,error:t}=await u.from("badge_definitions").select("*").order("sort_order");if(t)throw t;const{data:o,error:r}=await u.from("user_badges").select("*").eq("user_id",l.id);if(r)throw r;const{data:n,error:a}=await u.from("user_profiles").select("*").eq("user_id",l.id).single();if(a)throw a;const{count:s}=await u.from("user_bookmarks").select("*",{count:"exact",head:!0}).eq("user_id",l.id),i=document.getElementById("badges-grid");if(!i)return;i.innerHTML="",e.forEach(d=>{const m=o.find(N=>N.badge_type===d.badge_type),v=Nt(d,n,s),D=Ht(d,m,v);i.appendChild(D)})}catch(e){console.error("Error loading user badges:",e)}}function Nt(e,t,o){let r=0;const n=e.requirement_value;switch(e.requirement_type){case"watch_time":r=t.total_watch_time||0;break;case"movie_count":r=t.movies_watched||0;break;case"series_count":r=t.series_watched||0;break;case"series_complete":r=t.series_completed||0;break;case"night_sessions":r=t.night_sessions||0;break;case"morning_sessions":r=t.morning_sessions||0;break;case"streak_days":r=t.consecutive_days||0;break;case"bookmark_count":r=o||0;break;case"watch_count":r=(t.movies_watched||0)+(t.series_watched||0);break;case"genre_variety":r=t.genres_watched?JSON.parse(t.genres_watched).length:0;break;case"country_variety":r=t.countries_watched?JSON.parse(t.countries_watched).length:0;break;case"account_age":r=Math.floor((new Date-new Date(t.created_at))/(1e3*60*60*24));break;default:r=0}const a=Math.min(Math.round(r/n*100),100);return{current:r,required:n,percentage:a}}function Ht(e,t,o){const r=document.createElement("div");if(r.className=`badge-card ${t?"earned":"locked"}`,e.badge_color){r.style.setProperty("--badge-color",e.badge_color);const s=Ut(e.badge_color);r.style.setProperty("--badge-color-rgb",`${s.r}, ${s.g}, ${s.b}`)}const n=t?"":`
    <div class="badge-progress-section">
      <div class="badge-progress-bar">
        <div class="badge-progress-fill" style="width: ${o.percentage}%"></div>
      </div>
      <div class="badge-progress-text">
        ${Ot(e.requirement_type,o.current,o.required)}
      </div>
    </div>
  `,a=t?`
    <div class="badge-earned-date">
      <i class="fas fa-check-circle"></i> Earned ${new Date(t.earned_at).toLocaleDateString()}
    </div>
  `:"";return r.innerHTML=`
    <div class="badge-icon-wrapper">
      <i class="${e.badge_icon||"fas fa-trophy"}"></i>
    </div>
    <div class="badge-info">
      <div class="badge-name">${e.badge_name}</div>
      <div class="badge-description">${e.badge_description}</div>
      ${n}
      ${a}
    </div>
  `,r}function Ot(e,t,o){switch(e){case"watch_time":const r=Math.floor(t/3600),n=Math.floor(o/3600);return`${r}h / ${n}h`;case"movie_count":case"series_count":case"series_complete":case"watch_count":return`${t} / ${o}`;case"streak_days":return`${t} / ${o} days`;case"bookmark_count":return`${t} / ${o} items`;case"night_sessions":case"morning_sessions":return`${t} / ${o} sessions`;case"genre_variety":return`${t} / ${o} genres`;case"country_variety":return`${t} / ${o} countries`;case"account_age":return`${t} / ${o} days`;default:return`${Math.min(Math.round(t/o*100),100)}%`}}function Ut(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:229,g:9,b:20}}async function Ft(e){if(l)try{const t=new Date().toISOString().split("T")[0],o=e.last_login_date;let r=e.consecutive_days||0;if(!o)r=1;else{const n=new Date(o),a=new Date(t),s=Math.floor((a-n)/(1e3*60*60*24));s===1?r=(e.consecutive_days||0)+1:s>1&&(r=1)}o!==t&&(await u.from("user_profiles").update({consecutive_days:r,last_login_date:t}).eq("user_id",l.id),await Pe())}catch(t){console.error("Error updating login streak:",t)}}async function Rt(e,t,o=[]){if(!(!l||!t||t<60))try{const{data:r,error:n}=await u.from("user_profiles").select("*").eq("user_id",l.id).single();if(n)throw n;const a=new Date().getHours(),s=a>=0&&a<6,i=a>=5&&a<8,d={total_watch_time:(r.total_watch_time||0)+Math.floor(t)};if(e==="movie"?d.movies_watched=(r.movies_watched||0)+1:e==="tv"&&(d.series_watched=(r.series_watched||0)+1),s&&(d.night_sessions=(r.night_sessions||0)+1),i&&(d.morning_sessions=(r.morning_sessions||0)+1),o&&o.length>0){const m=r.genres_watched?JSON.parse(r.genres_watched):[],v=[...new Set([...m,...o])];d.genres_watched=JSON.stringify(v)}await u.from("user_profiles").update(d).eq("user_id",l.id),await u.from("watch_sessions").insert({user_id:l.id,session_date:new Date().toISOString(),session_hour:a,watch_duration:Math.floor(t),media_type:e,genre_ids:JSON.stringify(o||[])}),await Pe()}catch(r){console.error("Error updating watch time stats:",r)}}async function Pe(){if(l)try{const{error:e}=await u.rpc("check_and_award_badges",{p_user_id:l.id});if(e)throw e;document.getElementById("account-modal").classList.contains("active")&&(await Ae(),await qe())}catch(e){console.error("Error checking badges:",e)}}async function zt(){if(!l)return;const e=document.getElementById("save-profile-btn"),t=e.innerHTML;e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...';try{const o=document.getElementById("profile-display-name").value.trim(),r=document.getElementById("profile-favorite-genre"),n=r?r.value:null;if(!o){c("Please enter a display name","error"),e.disabled=!1,e.innerHTML=t;return}const a={display_name:o};n&&(a.favorite_genre=n);const{error:s}=await u.from("user_profiles").update(a).eq("user_id",l.id);if(s)throw s;c("Profile saved successfully!","success")}catch(o){console.error("Error saving profile:",o),c("Failed to save profile","error")}finally{e.disabled=!1,e.innerHTML=t}}async function jt(e){if(!(!l||!e))try{if(!["image/png","image/jpeg","image/jpg","image/webp"].includes(e.type)){c("Please upload a PNG, JPG, or WebP image","error");return}if(e.size>5*1024*1024){c("Image must be less than 5MB","error");return}c("Uploading avatar...","warning");const o=e.name.split(".").pop(),r=`${l.id}/avatar.${o}`,{error:n}=await u.storage.from("avatars").upload(r,e,{upsert:!0});if(n)throw n;const{data:a}=u.storage.from("avatars").getPublicUrl(r),s=a.publicUrl+"?t="+new Date().getTime(),{error:i}=await u.from("user_profiles").update({avatar_url:s}).eq("user_id",l.id);if(i)throw i;document.getElementById("profile-avatar-display").src=s;const d=document.querySelector(".user-avatar");d&&(d.src=s,d.style.opacity="0",setTimeout(()=>{d.style.transition="opacity 0.3s ease",d.style.opacity="1"},50)),c("Avatar updated successfully!","success")}catch(t){console.error("Error uploading avatar:",t),c("Failed to upload avatar","error")}}function Yt(){document.querySelectorAll(".profile-tab").forEach(a=>{a.addEventListener("click",()=>{const s=a.dataset.tab;document.querySelectorAll(".profile-tab").forEach(i=>i.classList.remove("active")),document.querySelectorAll(".profile-tab-content").forEach(i=>i.classList.remove("active")),a.classList.add("active"),document.getElementById(`${s}-tab`).classList.add("active")})});const e=document.getElementById("save-profile-btn");e&&e.addEventListener("click",zt);const t=document.getElementById("account-link");t&&t.addEventListener("click",()=>{setTimeout(()=>{if(!document.querySelector(".custom-genre-selector"))Wt();else{const s=document.getElementById("profile-favorite-genre");if(s&&s.value){const i=s.querySelector(`option[value="${s.value}"]`);if(i){const d=document.querySelector(".selected-genre-text");d&&(d.textContent=i.textContent)}}}},100)});const o=document.querySelector(".profile-avatar-wrapper"),r=document.getElementById("avatar-upload-input");o&&r&&(o.addEventListener("click",()=>{r.click()}),r.addEventListener("change",a=>{const s=a.target.files[0];s&&jt(s)}));const n=document.getElementById("change-password-settings");n&&n.addEventListener("click",()=>{c("Password reset email sent!","success"),u.auth.resetPasswordForEmail(l.email)})}function Wt(){const e=document.getElementById("profile-favorite-genre");if(!e)return;let t=e.value||"";e.style.display="none";const o=document.createElement("div");o.className="custom-genre-selector",o.innerHTML=`
    <div class="genre-selector-trigger">
      <span class="selected-genre-text">Select your favorite genre</span>
      <i class="fas fa-chevron-down"></i>
    </div>
  `,e.parentNode.insertBefore(o,e.nextSibling);const r=Array.from(e.options).filter(i=>i.value).map(i=>({value:i.value,text:i.textContent})),n=o.querySelector(".selected-genre-text");if(e.value){t=e.value;const i=r.find(d=>d.value===e.value);i&&(n.textContent=i.text,n.style.color="#fff")}const a=document.createElement("div");a.className="genre-modal",a.innerHTML=`
    <div class="genre-modal-overlay"></div>
    <div class="genre-modal-container">
      <div class="genre-modal-header">
        <h3>Choose Your Favorite Genre</h3>
        <button class="genre-modal-close">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="genre-grid">
        ${r.map(i=>`
          <div class="genre-option" data-value="${i.value}">
            <div class="genre-icon">
              <i class="${Jt(i.value)}"></i>
            </div>
            <span class="genre-name">${i.text}</span>
          </div>
        `).join("")}
      </div>
    </div>
  `,document.body.appendChild(a),o.querySelector(".genre-selector-trigger").addEventListener("click",()=>{a.classList.add("active"),setTimeout(()=>a.classList.add("show"),50)});const s=()=>{a.classList.remove("show"),setTimeout(()=>a.classList.remove("active"),300)};a.querySelector(".genre-modal-close").addEventListener("click",s),a.querySelector(".genre-modal-overlay").addEventListener("click",s),a.querySelectorAll(".genre-option").forEach(i=>{i.addEventListener("click",()=>{const d=i.dataset.value,m=i.querySelector(".genre-name").textContent;t=d,a.querySelectorAll(".genre-option").forEach(v=>{v!==i&&v.classList.add("disappear")}),i.classList.add("selected"),setTimeout(()=>{e.value=d,e.setAttribute("data-genre-value",d),n.textContent=m,n.style.color="#fff",s(),setTimeout(()=>{a.querySelectorAll(".genre-option").forEach(v=>{v.classList.remove("disappear","selected")})},300)},600)})}),window.getSelectedGenre=()=>t}function Jt(e){return{action:"fas fa-fist-raised",comedy:"fas fa-laugh",drama:"fas fa-theater-masks",horror:"fas fa-ghost","sci-fi":"fas fa-rocket",thriller:"fas fa-user-secret",romance:"fas fa-heart",documentary:"fas fa-film",animation:"fas fa-palette"}[e]||"fas fa-star"}
